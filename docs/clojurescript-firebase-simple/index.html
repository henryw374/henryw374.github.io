<!DOCTYPE html>
<html>
  <head>
    <title>Wrapper-free Firebase with Clojurescript's Re-Frame – Henry Widd's Blog – Widd Industries</title>

        <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>

    
    <meta name="description" content="I recently made my first crud-style hobby app with Firebase and 
I wanted to write it in Clojurescript…. of course ;-)
" />
    <meta property="og:description" content="I recently made my first crud-style hobby app with Firebase and 
I wanted to write it in Clojurescript…. of course ;-)
" />
    
    <meta name="author" content="Henry Widd's Blog" />

    
    <meta property="og:title" content="Wrapper-free Firebase with Clojurescript's Re-Frame" />
    <meta property="twitter:title" content="Wrapper-free Firebase with Clojurescript's Re-Frame" />
    

    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" title="Henry Widd's Blog - Widd Industries" href="/feed.xml" />

    <!-- Created with Jekyll Now - http://github.com/barryclark/jekyll-now -->
      <script data-ad-client="ca-pub-8297539495195641" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  </head>

  <body>
    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          <a href="/" class="site-avatar"><img src="https://avatars0.githubusercontent.com/u/3070220?s=400&u=a24a48324882a361ab3dc02dd865ec9b71c079d1&v=4" /></a>

          <div class="site-info">
            <h1 class="site-name"><a href="/">Henry Widd's Blog</a></h1>
            <p class="site-description">Widd Industries</p>
          </div>

          <nav>
            <a href="/">Blog</a>
            <a href="/about">About</a>
          </nav>
        </header>
      </div>
    </div>

    <div id="main" role="main" class="container">
      <article class="post">
  <h1>Wrapper-free Firebase with Clojurescript's Re-Frame</h1>

  <div class="entry">
    <p>I recently made my first crud-style hobby app with Firebase and 
I wanted to write it in Clojurescript…. of course ;-)</p>

<p>Looking around the internet for pointers, I found some Clojurescript-Firebase wrapper libraries I am 
not too keen on, and no great demo apps either… so I created <a href="https://github.com/henryw374/firerebase-clojurescript-todo-list">my own demo ‘todo-list’ app</a></p>

<p>The README there contains a small list of instructions that should get you up and running quickly and deploying the 
app to the internet in no time. Then you can spend many happy hours building from there.</p>

<h1 id="firebase-wrappers">Firebase Wrappers?</h1>

<p><a href="https://lmgtfy.app/?q=clojurescript+firebase">Googling for ‘Clojurescript Firebase’</a> I found a couple 
of ‘wrapper libraries’, <a href="https://github.com/deg/re-frame-firebase">re-frame-firebase</a> 
and <a href="https://github.com/fbielejec/cljs-firebase-client">cljs-firebase-client</a>.</p>

<p>I’ve <a href="https://widdindustries.com/why-not-interop/">written before</a> about
wrappers - tl;dr approach with caution.</p>

<p>There are obvious issues with the wrappers mentioned above:</p>

<ul>
  <li>They’re made to work for now-old versions of Firebase.</li>
  <li>They tie in to specifics like shadow or cljsjs</li>
  <li>They introduce some new stuff I have to understand</li>
  <li>… and ofc they don’t have the glitzy docs and tutorials that the Firebase site does.</li>
</ul>

<p>The <a href="https://github.com/fbielejec/cljs-firebase-client">cljs-firebase-client</a> lib
is billed as a library, but it looks very unfinished. It might have some snippets you 
could borrow, especially if you want to use Shadow.</p>

<p>The <a href="https://github.com/deg/re-frame-firebase">re-frame-firebase</a> lib has an api to cover pretty 
much all of Firebase I think, so there’s a lot of code. It also has some dependencies I’m not sure 
I want:</p>

<ul>
  <li>Re-frame wrapper lib (iron)</li>
  <li>clojure.spec</li>
</ul>

<p>and of most concern is way state from Firebase (auth-state, database contents) is stored in 
the Re-frame ‘app-db’. The authors note this is <a href="https://github.com/deg/re-frame-firebase/blob/ed5eabb6caa404af3395e3c97cb59a7c4d302c6b/src/com/degel/re_frame_firebase/database.cljs#L56">a potential bug</a>
and indeed it is. It’s also not necessary, as I’ll demonstrate below.</p>

<h1 id="wrapper-free-firebase">Wrapper-free Firebase</h1>

<p>The Firebase docs are great and got me a non-cljs ‘hello, world’ very easily. Could I bring in 
Clojurescript without introducing much new complexity? Well, I’ve attempted that in the todo app - see what
you think.</p>

<p>One thing you’ll notice with Firebase is that you pick and choose the APIs you want to include. For example 
if you want to use a database,
you get a choice of two different ones. This is nice and in my todo-list app, I use just ‘auth’ and ‘realtime database’,
so that’s all you’ll see any code for.</p>

<h2 id="auth-with-re-frame">Auth with Re-Frame</h2>

<p>The todo app requires users to authenticate with a Google login.</p>

<p>Firebase has a simple api to trigger this. The interesting bit from a Clojurescript point of view
is listening for the user information once they have successfully authenticated:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">user-info</span><span class="w"> </span><span class="p">[]</span><span class="w">
  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="n">auth-state</span><span class="w"> </span><span class="p">(</span><span class="nf">r/atom</span><span class="w"> </span><span class="n">nil</span><span class="p">)</span><span class="w"> </span><span class="p">]</span><span class="w">
    </span><span class="p">(</span><span class="nf">.onAuthStateChanged</span><span class="w"> </span><span class="p">(</span><span class="nf">auth</span><span class="p">)</span><span class="w">
      </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[</span><span class="n">user</span><span class="p">]</span><span class="w">
           </span><span class="p">(</span><span class="nf">reset!</span><span class="w"> </span><span class="n">auth-state</span><span class="w"> </span><span class="p">(</span><span class="nf">user-&gt;data</span><span class="w"> </span><span class="n">user</span><span class="p">))))</span><span class="w">
    </span><span class="n">auth-state</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>This function that returns a Reagent atom that will contain user information when it is available.
We can call this function any time and use the result in a reactive context, such as in a Reagent component -
It doesn’t matter if the user has already authenticated or not at the time the function is invoked.</p>

<p>There’s no need to store the user data in the app-db. Doing so would leave us with more state to 
manage, clean up and so on. There’s no Re-frame involvement required, but we could tie this 
function into a re-frame subscription as I’ll demonstrate next.</p>

<h2 id="realtime-database-with-re-frame">‘Realtime database’ with Re-Frame</h2>

<p>Pushing data to the database is pretty straightforward and well documented and you can imagine how
those calls might be wrapped up as <a href="https://day8.github.io/re-frame/api-builtin-effects/#what-are-effects">Re-Frame ‘effects’</a>,
as they have been in the ‘todo’ demo app.</p>

<p>Listening for data with Re-frame is a bit more interesting though. Similar to the atom that contained
the auth data above, we can have a function to return a Reaction (same thing as reactive atom effectively) 
containing the current value at some path in the Firebase database:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">defn</span><span class="w"> </span><span class="n">on-value</span><span class="w"> </span><span class="p">[{</span><span class="no">:keys</span><span class="w"> </span><span class="p">[</span><span class="nb">path</span><span class="p">]}]</span><span class="w">
  </span><span class="p">(</span><span class="k">let</span><span class="w"> </span><span class="p">[</span><span class="nb">ref</span><span class="w"> </span><span class="o">^</span><span class="n">js</span><span class="w"> </span><span class="p">(</span><span class="nf">db/fb-ref</span><span class="w"> </span><span class="nb">path</span><span class="p">)</span><span class="w">
        </span><span class="nb">val</span><span class="w"> </span><span class="p">(</span><span class="nf">r/atom</span><span class="w"> </span><span class="n">nil</span><span class="p">)</span><span class="w">
        </span><span class="n">callback</span><span class="w"> </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="w"> </span><span class="p">(</span><span class="nf">reset!</span><span class="w"> </span><span class="nb">val</span><span class="w"> </span><span class="p">(</span><span class="nf">-&gt;clj</span><span class="w"> </span><span class="n">x</span><span class="p">)))]</span><span class="w">
    </span><span class="p">(</span><span class="nf">.on</span><span class="w"> </span><span class="nb">ref</span><span class="w"> </span><span class="s">"value"</span><span class="w"> </span><span class="n">callback</span><span class="p">)</span><span class="w">
    </span><span class="p">(</span><span class="nf">reagent.atom/make-reaction</span><span class="w">
      </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="p">[]</span><span class="w"> </span><span class="o">@</span><span class="nb">val</span><span class="p">)</span><span class="w">
      </span><span class="no">:on-dispose</span><span class="w"> </span><span class="o">#</span><span class="p">(</span><span class="nf">do</span><span class="w"> </span><span class="p">(</span><span class="nf">.off</span><span class="w"> </span><span class="nb">ref</span><span class="w"> </span><span class="s">"value"</span><span class="w"> </span><span class="n">callback</span><span class="p">)))))</span><span class="w">
</span></code></pre></div></div>

<p>The ‘Reaction’ object returned from this function will be updated with the current value whenever 
it changes - nice! Now, if we want to use that as part of a Re-frame subscription, we can call it 
from a <a href="https://github.com/day8/re-frame/blob/2965ffeda9b8f3b687e2c3e0ba9a62e7fe64c0bb/src/re_frame/core.cljc#L201">Signal function</a></p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nf">rf/reg-sub</span><span class="w"> </span><span class="no">::foo</span><span class="w"> 
  </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="n">this-is-the-signal-function</span><span class="w"> </span><span class="p">[[</span><span class="n">_</span><span class="w"> </span><span class="n">args</span><span class="p">]]</span><span class="w">
    </span><span class="p">{</span><span class="no">:bar</span><span class="w"> </span><span class="p">(</span><span class="nf">on-value</span><span class="w"> </span><span class="n">args</span><span class="p">)})</span><span class="w">
  </span><span class="p">(</span><span class="k">fn</span><span class="w"> </span><span class="n">this-is-compute-function</span><span class="w"> </span><span class="p">[{</span><span class="no">:keys</span><span class="w"> </span><span class="p">[</span><span class="n">bar</span><span class="p">]}]</span><span class="w">
     </span><span class="c1">;... do some further transform with 'bar' value from db</span><span class="w">
  </span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>If you haven’t used signal functions before, it’s well worth a read of the <a href="https://github.com/day8/re-frame/blob/2965ffeda9b8f3b687e2c3e0ba9a62e7fe64c0bb/src/re_frame/core.cljc#L201">hefty docstring</a> 
to understand them. The todo-list app demonstrates this in action.</p>

<p>So… we can read and write data, and the Re-frame ‘app-db’ is nowhere in sight. I haven’t got 
anything against the app-db - but I don’t want to stuff in there unnecessarily - because for any 
data in there, you have to understand what effects put it there, how it’s lifecycle is managed and so on. I might write more about this in a later post.</p>

<p>Firebase stores the data in the cloud and keeps a local copy of that sync’ed in the <a href="https://developer.mozilla.org/en-US/docs/Learn/JavaScript/Client-side_web_APIs/Client-side_storage">browser’s store</a> in 
case the connection drops. Re-frame handles doing minimal computation work, de-duping subscriptions etc. 
So… let’s just lean on all that awesome machinery!</p>

<p>What about data the user is editing? In the todo app, that is component-local state only when 
the user is actually changing it, and is sent off to Firebase via <code class="language-plaintext highlighter-rouge">re-frame/dispatch</code> at
the appropriate time.</p>

<p>In fact, in this little example you might see Re-Frame as overkill and just stick with Reagent.</p>

<p>One last point about the Firebase database - it’s json data of course, so it’s not going to work to 
create Clojure maps with the usual edn goodies like 
non-string keys, namespaced keywords &amp; etc. A nice approach to stay in JS/JSON
land is to use <a href="https://github.com/mfikes/cljs-bean">cljs-bean</a> for your data, rather than native 
Clojure datastructures.</p>

<h2 id="compile-and-deploy">Compile and Deploy</h2>

<p>The todo-list README demonstrates doing a build with advanced compilation.</p>

<p>The build includes the <code class="language-plaintext highlighter-rouge">:infer-externs</code> option, which uses the <code class="language-plaintext highlighter-rouge">^js</code> <a href="https://code.thheller.com/blog/shadow-cljs/2017/11/06/improved-externs-inference.html">tag metadata</a>
to let the compiler know to leave the calls to the Firebase APIs as they are.</p>

<p>Keep these compiler debug opts handy if you do get any problems with the minified build (ie you see
error messages in the browser console like ‘x.y is not a function’):</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="k">def</span><span class="w"> </span><span class="n">debug-opts</span><span class="w">
  </span><span class="p">{</span><span class="no">:pseudo-names</span><span class="w"> </span><span class="n">true</span><span class="w">
   </span><span class="no">:pretty-print</span><span class="w"> </span><span class="n">true</span><span class="w">
   </span><span class="no">:source-map</span><span class="w"> </span><span class="n">true</span><span class="w">
   </span><span class="p">})</span><span class="w">
</span></code></pre></div></div>

<h2 id="conclusion">Conclusion</h2>

<p>Firebase seems pretty nice for a hobby project - and maybe for more serious apps too. Using it with
Clojurescript and Re-Frame is straightforward and a natural fit. For example, Firebase <code class="language-plaintext highlighter-rouge">onValue</code> lets
you listen for the latest value in some part of the database and that is easily hooked into a Re-frame
subscription so the view magically updates whenever the database does. Simples!</p>

<p>Some points of note:</p>

<ul>
  <li>Firebase-wrapping libraries aren’t necessary because you’ll learn just the bits you need from firebase docs.</li>
  <li>Avoid putting Firebase state in the Re-Frame app-db. <a href="https://github.com/day8/re-frame/blob/2965ffeda9b8f3b687e2c3e0ba9a62e7fe64c0bb/src/re_frame/core.cljc#L201">Signal functions</a> will hold state for just as long as necessary.</li>
  <li>No need for externs, <code class="language-plaintext highlighter-rouge">^js</code> type hints are all that’s required.</li>
  <li>Bundling Firebase libraries via npm or cljsjs is strictly optional.</li>
  <li>Develop the app locally with the Firebase emulator</li>
  <li>Stay JSON-friendly with <a href="https://github.com/mfikes/cljs-bean">cljs-bean</a></li>
</ul>

  </div>

  <div class="date">
    Written on February 19, 2021
  </div>

  
<div class="comments">
	<div id="disqus_thread"></div>
	<script type="text/javascript">

	    var disqus_shortname = 'widdindustries';

	    (function() {
	        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	    })();

	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

</article>

    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          



<a href="https://github.com/henryw374"><i class="svg-icon github"></i></a>



<a href="/feed.xml"><i class="svg-icon rss"></i></a>
<a href="https://www.twitter.com/henryw374"><i class="svg-icon twitter"></i></a>



        </footer>
      </div>
    </div>

    <style>
    #cookie-notice {padding: 0.5rem 1rem; display: none; text-align: center; position: fixed; bottom: 0; width: calc(100% - 2rem); background: #222; color: rgba(255,255,255,0.8);}
    #cookie-notice a {display: inline-block; cursor: pointer; margin-left: 0.5rem;}
    @media (max-width: 767px) {
        #cookie-notice span {display: block; padding-top: 3px; margin-bottom: 1rem;}
        #cookie-notice a {position: relative; bottom: 4px;}
    }
</style>
<div id="cookie-notice"><span>We would like to use third party cookies and scripts to improve the functionality of this website.</span><a id="cookie-notice-accept" class="btn btn-primary btn-sm">Approve</a><a href="/privacy" class="btn btn-primary btn-sm">More info</a></div>
<script>
    function createCookie(name,value,days) {
        var expires = "";
        if (days) {
            var date = new Date();
            date.setTime(date.getTime() + (days*24*60*60*1000));
            expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + value + expires + "; path=/";
    }
    function readCookie(name) {
        var nameEQ = name + "=";
        var ca = document.cookie.split(';');
        for(var i=0;i < ca.length;i++) {
            var c = ca[i];
            while (c.charAt(0)==' ') c = c.substring(1,c.length);
            if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
        }
        return null;
    }
    function eraseCookie(name) {
        createCookie(name,"",-1);
    }

    if(readCookie('cookie-notice-dismissed')=='true') {
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		ga('create', 'UA-131917038-1', 'auto');
		ga('send', 'pageview', {
		  'page': '/clojurescript-firebase-simple/',
		  'title': 'Wrapper-free Firebase with Clojurescript\'s Re-Frame'
		});
    } else {
        document.getElementById('cookie-notice').style.display = 'block';
    }
    document.getElementById('cookie-notice-accept').addEventListener("click",function() {
        createCookie('cookie-notice-dismissed','true',31);
        document.getElementById('cookie-notice').style.display = 'none';
        location.reload();
    });

</script>

  </body>
</html>
