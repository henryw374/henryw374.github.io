<!DOCTYPE html>
<html>
  <head>
    <title>Why not Interop with java.time? – Henry Widd's Blog – Widd Industries</title>

        <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>

    
    <meta name="description" content="Some in the Clojure community would say that if a Java or JS API is good, then it needn’t be 
‘wrapped’ in a library, because plain interop code is idiomatic and any wrapping
library might:
" />
    <meta property="og:description" content="Some in the Clojure community would say that if a Java or JS API is good, then it needn’t be 
‘wrapped’ in a library, because plain interop code is idiomatic and any wrapping
library might:
" />
    
    <meta name="author" content="Henry Widd's Blog" />

    
    <meta property="og:title" content="Why not Interop with java.time?" />
    <meta property="twitter:title" content="Why not Interop with java.time?" />
    

    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" title="Henry Widd's Blog - Widd Industries" href="/feed.xml" />

    <!-- Created with Jekyll Now - http://github.com/barryclark/jekyll-now -->
      <script data-ad-client="ca-pub-8297539495195641" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  </head>

  <body>
    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          <a href="/" class="site-avatar"><img src="https://avatars0.githubusercontent.com/u/3070220?s=400&u=a24a48324882a361ab3dc02dd865ec9b71c079d1&v=4" /></a>

          <div class="site-info">
            <h1 class="site-name"><a href="/">Henry Widd's Blog</a></h1>
            <p class="site-description">Widd Industries</p>
          </div>

          <nav>
            <a href="/">Blog</a>
            <a href="/about">About</a>
          </nav>
        </header>
      </div>
    </div>

    <div id="main" role="main" class="container">
      <article class="post">
  <h1>Why not Interop with java.time?</h1>

  <div class="entry">
    <p>Some in the Clojure community would say that if a Java or JS API is good, then it needn’t be 
‘wrapped’ in a library, because plain interop code is idiomatic and any wrapping
library might:</p>

<ul>
  <li>Miss out something of the underlying API (so you likely need to know both anyway)</li>
  <li>Have fewer tests/documentation/community etc</li>
  <li>Introduce some subtle new semantics</li>
  <li>Not keep up with releases of the underlying</li>
</ul>

<p>Those concerns all seem reasonable, but consider <a href="https://github.com/henryw374/cljc.java-time">this java.time wrapper</a>.
Every one of the above concerns is addressed: The Clojure API is identical to the underlying Java API (addresses first 3 points) and the
underlying API is stable (last point).</p>

<p>Okaaaay … but if it’s so similar, why use it at all?</p>

<p>The library’s main reason to exist is because it works cross-platform, a huge win on my current projects - but let’s leave that aside for the moment and consider the 
jvm-only POV.</p>

<h2 id="camel-kebab-wrapping-benefits">Camel-&gt;Kebab wrapping benefits</h2>

<ul>
  <li>All type hinting is done for you</li>
  <li>comp, apply, juxt and all other clojure.core higher-order fns can now be used rather than anon fn interop: <code class="language-plaintext highlighter-rouge">#(.bar %)</code></li>
  <li>In fact, instead of seeing code like <code class="language-plaintext highlighter-rouge">#(.isAfter %)</code>, you’ll use a properly namespaced clojure function <code class="language-plaintext highlighter-rouge">x.y/is-after</code> - much better!</li>
  <li>The Javadoc of the original API will be more readily available via Clojure docstrings (see <a href="https://github.com/henryw374/cljc.java-time/issues/16">issue</a>)</li>
</ul>

<h2 id="additional-api">Additional API</h2>

<ul>
  <li>Predicates, for example <code class="language-plaintext highlighter-rouge">(local-date? x)</code></li>
</ul>

<p>This could be used for spec definitions for example.</p>

<h2 id="exceptions-that-say-something-helpful">Exceptions That Say Something Helpful</h2>

<p>This is a very recent addition (<a href="https://clojars.org/cljc.java-time">0.1.12</a> and takes a bit of explaining. In java.time, you have an <code class="language-plaintext highlighter-rouge">Instant</code> which is equivalent to a
<code class="language-plaintext highlighter-rouge">java.util.Date</code> in that it’s instances represent <code class="language-plaintext highlighter-rouge">the start of a nanosecond on the timeline</code>. Now the tricky thing
about Instants is that the only field/data they contain is an offset from the UNIX Epoch (midnight, Jan 1st 1970, UTC). Instants
know nothing about years, months, days, hours etc etc. In the lingo, they are not ‘calendar-aware’, so you cannot add
a year to an Instant or ask for it’s day of the week. BUT… the API kind of suggests that might be possible.</p>

<p>Firstly, let’s see the output of <code class="language-plaintext highlighter-rouge">Instant#toString</code>:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mi">2013</span><span class="o">-</span><span class="mo">05</span><span class="o">-</span><span class="mi">30</span><span class="nl">T23:</span><span class="mi">38</span><span class="o">:</span><span class="mf">23.085</span><span class="no">Z</span>
</code></pre></div></div>

<p>Hold on, how and why is that printing years, months &amp; etc? Well, an Instant can be converted into a calendar representation and 
that’s what the <code class="language-plaintext highlighter-rouge">toString()</code> implementation does. That auto-conversion is the exception rather than the rule though, if you try to format
an Instant as ‘yyyy-mm-dd’ you’ll see what I mean.</p>

<p>On a related note, try adding a year to an Instant:</p>

<div class="language-clojure highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">(</span><span class="nb">-&gt;</span><span class="w"> </span><span class="p">(</span><span class="nf">Instant/now</span><span class="p">)</span><span class="w">
    </span><span class="p">(</span><span class="nf">.plus</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">ChronoUnit/YEARS</span><span class="p">))</span><span class="w">
</span></code></pre></div></div>

<p>It compiles ok, but at runtime you’ll get a run-time exception: <code class="language-plaintext highlighter-rouge">Unsupported Field : YearOfEra</code>.</p>

<p>So what’s the problem here? People should just learn this basic fact about the java.time API before using it, right?</p>

<p>In practice, I see this issue about Instant and calendar-awareness come up a lot - via colleagues, github issues, stackoverflow &amp; etc</p>

<p>My guess is that a lot of people only need to work with dates infrequently enough that they don’t feel it’s worth investing time
going through the tutorials, or if they do, the nuances quickly fade through lack of practice.</p>

<p>Having seen this problem in the wild again and again for many years I have decided to take action!</p>

<p>If you now do some erroneous thing with Instant in cljc.java-time, like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>(-&gt; (cljc.java-time.instant/now)
    (cljc.java-time.instant/plus 1 cljc.java-time.temporal.chrono-unit/years))
</code></pre></div></div>

<p>You get an exception with message:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Hi there! - It looks like you might be trying to do something with a java.time.Instant that would require it to be 'calendar-aware', 
but since it isn't, it has no facility with working with years, months, days etc. 
To get around that, consider converting the Instant to a ZonedDateTime first or for formatting/parsing specifically, 
you might add a zone to your formatter. see https://stackoverflow.com/a/27483371/1700930. 
 
You can disable these custom exceptions by setting -Dcljc.java-time.disable-helpful-exception-messages=true
</code></pre></div></div>

<p>That message alone should at least prevent a lot of github issues and questions I get …. let’s see!</p>

<p>I am adding that message because I think it’s unlikely I could get java.time messages changed, I don’t even 
know how I would do that. I do know how to make this suggestion for the new date-time API being made for the world’s most popular
programming language though, raise <a href="https://github.com/tc39/proposal-temporal/issues/1233">an issue!</a>. That
improved error message may be my greatest contribution to humanity to date ;-)</p>

<h1 id="what-about-traditional-wrappers-like-tick-or-clojurejava-time-">What about traditional wrappers like tick or clojure.java-time ?</h1>

<p>These are traditional wrappers and definitely come with trade-offs. In my work we use date logic a lot, which I think
means it’s an environment where it’s worth learning to use a wrapper because of the extra+improved API. That being said, I use a wrapper for 80% of 
regular date-arithmetic - for things I consider more obscure or esoteric, or where performance might suffer, I drop
to cljc.java-time (which tick is using under the hood) - and in very rare cases - plain interop.</p>

<p>If you have any thoughts/questions, please let me know ;-)</p>

  </div>

  <div class="date">
    Written on January  4, 2021
  </div>

  
<div class="comments">
	<div id="disqus_thread"></div>
	<script type="text/javascript">

	    var disqus_shortname = 'widdindustries';

	    (function() {
	        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
	        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
	    })();

	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>

</article>

    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          



<a href="https://github.com/henryw374"><i class="svg-icon github"></i></a>



<a href="/feed.xml"><i class="svg-icon rss"></i></a>
<a href="https://www.twitter.com/henryw374"><i class="svg-icon twitter"></i></a>



        </footer>
      </div>
    </div>

    <style>
    #cookie-notice {padding: 0.5rem 1rem; display: none; text-align: center; position: fixed; bottom: 0; width: calc(100% - 2rem); background: #222; color: rgba(255,255,255,0.8);}
    #cookie-notice a {display: inline-block; cursor: pointer; margin-left: 0.5rem;}
    @media (max-width: 767px) {
        #cookie-notice span {display: block; padding-top: 3px; margin-bottom: 1rem;}
        #cookie-notice a {position: relative; bottom: 4px;}
    }
</style>
<div id="cookie-notice"><span>We would like to use third party cookies and scripts to improve the functionality of this website.</span><a id="cookie-notice-accept" class="btn btn-primary btn-sm">Approve</a><a href="/privacy" class="btn btn-primary btn-sm">More info</a></div>
<script>
    function createCookie(name,value,days) {
        var expires = "";
        if (days) {
            var date = new Date();
            date.setTime(date.getTime() + (days*24*60*60*1000));
            expires = "; expires=" + date.toUTCString();
        }
        document.cookie = name + "=" + value + expires + "; path=/";
    }
    function readCookie(name) {
        var nameEQ = name + "=";
        var ca = document.cookie.split(';');
        for(var i=0;i < ca.length;i++) {
            var c = ca[i];
            while (c.charAt(0)==' ') c = c.substring(1,c.length);
            if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
        }
        return null;
    }
    function eraseCookie(name) {
        createCookie(name,"",-1);
    }

    if(readCookie('cookie-notice-dismissed')=='true') {
        (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
		(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
		m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		ga('create', 'UA-131917038-1', 'auto');
		ga('send', 'pageview', {
		  'page': '/why-not-interop/',
		  'title': 'Why not Interop with java.time?'
		});
    } else {
        document.getElementById('cookie-notice').style.display = 'block';
    }
    document.getElementById('cookie-notice-accept').addEventListener("click",function() {
        createCookie('cookie-notice-dismissed','true',31);
        document.getElementById('cookie-notice').style.display = 'none';
        location.reload();
    });

</script>

  </body>
</html>
